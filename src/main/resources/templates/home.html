<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Editor</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="header">
    <h2>Label Editor Tool</h2>
  </div>

  <div id="layoutContainer">
    <!-- Left panel -->
    <div id="leftPanel">
      <h3>Left Panel</h3>
      <!-- Future tools go here -->
    </div>

    <!-- Center panel -->
    <div id="centerPanel">
      <div class="form-group">
        <label for="width">Width (in):</label>
        <input id="width" type="number" value="1.5" step="0.1">
        <label for="height">Height (in):</label>
        <input id="height" type="number" value="1" step="0.1">
        <button onclick="updateLabel()">Update</button>
      </div>

      <form id="uploadForm" enctype="multipart/form-data" class="form-group">
        <input type="file" name="file" accept=".rptdesign" required>
        <input type="submit" value="Upload .rptdesign">
      </form>

      <div id="labelCanvas">
        <div id="labelBox"></div>
      </div>

      <div id="downloadContainer">
        <button onclick="downloadFile()">Download Edited File</button>
      </div>
    </div>

    <!-- Right panel -->
    <div id="rightPanel">
      <h3>File Structure</h3>
      <div id="labelStructure" class="scroll-box"></div>
    </div>
  </div>

  <script>
    function updateLabel() {
      const w = parseFloat(document.getElementById('width').value);
      const h = parseFloat(document.getElementById('height').value);
      const scale = 102;
      const label = document.getElementById('labelBox');
      label.style.width = (w * scale) + 'px';
      label.style.height = (h * scale) + 'px';

      fetch('/create-label', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ widthInInches: w, heightInInches: h })
      }).catch(err => alert("Label update failed: " + err));
    }

    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);

      resetLabel()
        .then(() => {
          return fetch('/upload', {
            method: 'POST',
            body: formData
          });
        })
        .then(response => {
          if (!response.ok) throw new Error("Upload failed");
          return response.text();
        })
        .then(() => {
          updateLabelSizeFromFile();
          renderLabelElements();
          loadLabelStructure();
        })
        .catch(err => alert("Upload failed: " + err));
    });

    function downloadFile() {
      window.location.href = '/download';
    }

    function renderLabelElements() {
      fetch('/label-elements')
        .then(res => res.json())
        .then(elements => {
          const box = document.getElementById('labelBox');
          box.innerHTML = '';

          elements.forEach(el => {
            const div = document.createElement('div');
            div.textContent = el.content;
            div.style.position = 'absolute';
            div.style.left = el.x + 'px';
            div.style.top = el.y + 'px';
            div.style.width = el.width + 'px';
            div.style.height = el.height + 'px';
            div.style.border = '1px dashed #999';
            div.style.color = '#000';
            div.style.padding = '2px';
            div.style.overflow = 'hidden';
            box.appendChild(div);
          });
        });
    }

    function updateLabelSizeFromFile() {
      fetch('/label-size')
        .then(res => res.json())
        .then(size => {
          document.getElementById('width').value = (size.width / 100).toFixed(2);
          document.getElementById('height').value = (size.height / 100).toFixed(2);
          updateLabel();
        });
    }

    function resetLabel() {
          return fetch('/label/reset', { method: 'POST' });
        }

        function renderTreeNode(node) {
      const container = document.createElement('div');
      container.className = 'tree-node';

      const label = document.createElement('span');
      label.textContent = node.name;
      label.className = 'tree-label';
      container.appendChild(label);

      if (node.children) {
        const toggle = document.createElement('button');
        toggle.textContent = '▶'; // collapsed icon
        toggle.className = 'tree-toggle';

        const childContainer = document.createElement('div');
        childContainer.className = 'tree-children hidden'; // ← hide by default

        toggle.onclick = () => {
          childContainer.classList.toggle('hidden');
          toggle.textContent = childContainer.classList.contains('hidden') ? '▶' : '▼';
        };

        container.insertBefore(toggle, label);
        node.children.forEach(child => childContainer.appendChild(renderTreeNode(child)));
        container.appendChild(childContainer);
      }

      return container;
    }

    function loadLabelStructure() {
      fetch('/label-structure')
        .then(res => res.json())
        .then(data => {
          const root = renderTreeNode(data);
          const panel = document.getElementById('labelStructure');
          panel.innerHTML = '';
          panel.appendChild(root);
        });
    }

    // Initial load
    updateLabel();
    loadLabelStructure();
  </script>
</body>
</html>
